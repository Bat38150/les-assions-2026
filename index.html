<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Les Assions 2026</title>

    <!-- PWA / th√®me -->
    <meta name="theme-color" content="#111827" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Les Assions 2026" />

    <!-- Manifest & ic√¥nes (√† adapter si besoin) -->
    <link rel="manifest" href="./public/manifest.json" />
    <link rel="icon" href="./public/icons/icon-192.png" />
    <link rel="apple-touch-icon" href="./public/icons/icon-192.png" />

    <!-- Tailwind -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    />
    <style>
      /* confort iOS: √©vite le zoom automatique */
      input,
      select,
      textarea,
      button {
        font-size: 16px;
      }
       /* ---- Th√®me vert campagne ---- */
  .btn-primary {
    background-color: #79AEA3;
    color: white;
    font-weight: 500;
    border-radius: 0.75rem; /* = rounded-xl */
    transition: all 0.2s ease-in-out;
  }
  .btn-primary:hover {
    background-color: #699b91;
  }
  .btn-primary:disabled {
    background-color: #a8c9c2;
    cursor: not-allowed;
  }
    </style>

    <!-- React + Babel -->
    <script
      src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"
      crossorigin
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Leaflet (carte OpenStreetMap, gratuit) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
    <!-- Marker cluster (utile si beaucoup de points) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster-src.js"></script>

    <!-- Service Worker simple -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./sw.js") // ‚Üê au lieu de "/sw.js"
            .then((reg) => console.log("SW registered:", reg.scope))
            .catch(console.error);
        });
      }
    </script>
  </head>

  <body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
      // ========================
      //   OUTBOX (offline)
      // ========================
      const OUTBOX_KEY = "la_outbox_v1";

      function outboxPush(row) {
        try {
          const arr = JSON.parse(localStorage.getItem(OUTBOX_KEY) || "[]");
          arr.push(row);
          localStorage.setItem(OUTBOX_KEY, JSON.stringify(arr));
        } catch {}
      }

      async function outboxFlush() {
        try {
          const arr = JSON.parse(localStorage.getItem(OUTBOX_KEY) || "[]");
          if (!arr.length) return;
          const remain = [];
          for (const row of arr) {
            try {
              await sendToSupabase(row);
            } catch {
              remain.push(row);
            }
          }
          localStorage.setItem(OUTBOX_KEY, JSON.stringify(remain));
        } catch {}
      }

      // ========================
      //   CONFIG
      // ========================
      const CONFIG = {
        SUPABASE_URL: "https://cgevhnbayhtnuxycypca.supabase.co",
        SUPABASE_ANON_KEY:
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnZXZobmJheWh0bnV4eWN5cGNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNTY0ODQsImV4cCI6MjA3NzgzMjQ4NH0.TLzl_7ybzsT6i29BXzA1mRjsgFIPIHWr0Vzu-FrVEdQ",
        TABLE: "distributions_2026", // üîÅ √† cr√©er / adapter dans Supabase
        AGENT_KEY: "la_agent_name_v1",
        LOGO_URL: "./public/assets/logo-assions-2026.png", // ou logo de campagne
        APP_NAME: "Les Assions 2026 ‚Äî Distributions",
        THEME_COLOR: "#111827",
      };

      // ========================
      //   Agents & mots de passe
      // ========================
      const AGENTS_LIST = [
        { id: "TCHA", name: "Tony CHAUVET", team: "Les Assions" },
        { id: "MPOU", name: "Martine POULIQUEN", team: "Les Assions" },
        { id: "BGIR", name: "Baptiste GIRARD", team: "Les Assions" },
        { id: "RMOR", name: "R√©gis MOREL", team: "Les Assions" },
        { id: "ISAV", name: "Igor SAVITCH", team: "Les Assions" },
        // üëâ ajoute ici les vrais noms / √©quipes
      ];

      // üîê mots de passe associ√©s aux agents (√† adapter √©videmment)
      const AGENT_PASSWORDS = {
        BGIR: "1234",
        ISAV: "1234",
        TCHA: "1234",
        MPOU: "1234",
        RMOR: "1234",
      };

      // ========================
      //   Hooks
      // ========================
      function useLocalStorage(key, initialValue) {
        const [value, setValue] = React.useState(() => {
          try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
          } catch {
            return initialValue;
          }
        });

        React.useEffect(() => {
          try {
            localStorage.setItem(key, JSON.stringify(value));
          } catch {}
        }, [key, value]);

        return [value, setValue];
      }

      // ========================
      //   Supabase helper
      // ========================
      async function sendToSupabase(row) {
        const url = `${CONFIG.SUPABASE_URL}/rest/v1/${CONFIG.TABLE}`;
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: CONFIG.SUPABASE_ANON_KEY,
            Authorization: `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
            Prefer: "return=minimal",
          },
          body: JSON.stringify(row),
        });
        if (!res.ok) {
          const t = await res.text();
          console.warn("Supabase POST failed", res.status, t);
          throw new Error(`HTTP ${res.status} ‚Äî ${t}`);
        }
        return true;
      }

      // ========================
      //   UI: Header
      // ========================
      function Header({ agentName, onLogout, logoUrl, appName, onOpenViewer }) {
        return (
          <header
            className="sticky top-0 z-40 bg-white border-b shadow-sm"
            style={{ paddingTop: "env(safe-area-inset-top)" }}
          >
            <div className="max-w-4xl mx-auto px-4">
              <div className="w-full flex flex-col sm:flex-row sm:items-center sm:justify-between py-3 gap-2 sm:gap-0">
                <div className="flex items-center gap-3">
                  {logoUrl ? (
                    <img
                      src={logoUrl}
                      alt="Logo"
                      className="w-8 h-8 rounded-lg object-contain border bg-white"
                      onError={(e) => (e.currentTarget.style.display = "none")}
                    />
                  ) : null}
                  <span className="font-semibold text-base sm:text-lg">
                    {appName || "Les Assions 2026 ‚Äî Distributions"}
                  </span>
                </div>
                <div className="flex items-center justify-end gap-2 text-sm sm:text-base">
                  <button
                    onClick={onOpenViewer}
                    className="px-3 py-1.5 rounded-xl border bg-white hover:bg-gray-50 text-sm"
                    title="Voir les points enregistr√©s"
                  >
                    üìç Viewer
                  </button>
                  <span className="text-gray-700 font-medium truncate max-w-[35vw] sm:max-w-[25vw]">
                    üë§ {agentName}
                  </span>
                  <button
                    onClick={onLogout}
                    className="inline-flex items-center gap-1 px-3 py-1.5 rounded-xl bg-gray-100 hover:bg-gray-200 text-sm sm:text-base"
                    title="Se d√©connecter"
                    aria-label="Se d√©connecter"
                  >
                    üö™ <span className="hidden sm:inline">Se d√©connecter</span>
                  </button>
                </div>
              </div>
            </div>
          </header>
        );
      }

      // ========================
      //   UI: √âcran de connexion
      // ========================
      function AgentSetup({ onSave }) {
        const [query, setQuery] = React.useState("");
        const [password, setPassword] = React.useState("");
        const [error, setError] = React.useState("");

        const resolveAgent = (q) => {
          const s = q.trim().toLowerCase();
          return (
            AGENTS_LIST.find((a) => a.id.toLowerCase() === s) ||
            AGENTS_LIST.find((a) => a.name.toLowerCase() === s)
          );
        };

        const save = () => {
          const agent = resolveAgent(query);
          if (!agent) {
            return setError("S√©lectionnez un nom valide dans la liste.");
          }

          const expectedPassword = AGENT_PASSWORDS[agent.id];
          if (!expectedPassword) {
            return setError("Aucun mot de passe configur√© pour cet agent.");
          }

          if (password !== expectedPassword) {
            return setError("Mot de passe incorrect.");
          }

          onSave({ id: agent.id, name: agent.name, team: agent.team });
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-50">
            <div className="w-full max-w-md bg-white rounded-2xl shadow p-6 text-center">
                <img
                  src={CONFIG.LOGO_URL}
                  alt="Logo de la campagne"
                  className="w-64 max-w-full mx-auto mb-6 object-contain drop-shadow-lg"
                  style={{
                    maxHeight: "180px",
                  }}
                  onError={(e) => (e.currentTarget.style.display = "none")}
                />
              <h1 className="text-xl font-semibold mb-1">Les Assions 2026</h1>
              <p className="text-sm text-gray-600 mb-4">
                Connectez-vous pour enregistrer vos distributions.
              </p>

              {/* Nom / identifiant */}
              <label className="block mb-4 text-left">
                <span className="text-sm text-gray-600">Votre nom (ou identifiant)</span>
                <input
                  list="agents"
                  className="mt-1 w-full border rounded-xl px-3 py-2 text-sm"
                  placeholder="Ex : Jean Dupont ou JDUP"
                  value={query}
                  onChange={(e) => {
                    setQuery(e.target.value);
                    setError("");
                  }}
                  autoCapitalize="words"
                  autoComplete="off"
                />
                <datalist id="agents">
                  {AGENTS_LIST.map((a) => (
                    <option key={a.id} value={a.name} />
                  ))}
                </datalist>
                <div className="mt-1 text-xs text-gray-500">
                  Astuce : vous pouvez aussi saisir votre identifiant (ex.{" "}
                  <code>JDUP</code>).
                </div>
              </label>

              {/* Mot de passe */}
              <label className="block mb-4 text-left">
                <span className="text-sm text-gray-600">Mot de passe</span>
                <input
                  type="password"
                  className="mt-1 w-full border rounded-xl px-3 py-2 text-sm"
                  placeholder="Mot de passe"
                  value={password}
                  onChange={(e) => {
                    setPassword(e.target.value);
                    setError("");
                  }}
                  autoComplete="off"
                />
              </label>

              {error && <p className="text-red-600 text-sm mb-3">{error}</p>}

              <button
                onClick={save}
                className="w-full btn-primary py-2.5"
              >
                C'est parti
              </button>
            </div>
          </div>
        );
      }

      // ========================
      //   UI: √âcran de distribution
      // ========================
      function DistributionScreen({ agent }) {
        const [street, setStreet] = React.useState("");
        const [comment, setComment] = React.useState("");
        const [citizenPhone, setCitizenPhone] = React.useState("");
        const [citizenEmail, setCitizenEmail] = React.useState("");
        const [status, setStatus] = React.useState("");
        const [error, setError] = React.useState("");
        const [saving, setSaving] = React.useState(false);
        const [locating, setLocating] = React.useState(false);
        const [success, setSuccess] = React.useState(false);
        const [coords, setCoords] = React.useState(null); // {lat, lng} ou null

        const mapRef = React.useRef(null);
        const markerRef = React.useRef(null);
        const mapContainerRef = React.useRef(null);

        React.useEffect(() => {
          setStatus(
            "Commune : Les Assions ‚Äî CP : 07140 ‚Äî Pays : France (fixes, seule l'adresse change)."
          );
        }, []);

            function showOnMap(lat, lng) {
              // V√©rifie que Leaflet est bien charg√©
              if (!window.L) {
                console.warn("Leaflet non charg√© (L indisponible).");
                return;
              }
            
              const position = [lat, lng]; // Leaflet attend [lat, lng]
            
              // Premi√®re cr√©ation de la carte
              if (!mapRef.current) {
                // Cr√©ation de la carte centr√©e sur la position
                mapRef.current = L.map(mapContainerRef.current).setView(position, 18);
            
                // Fonds de carte OpenStreetMap gratuits
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                  maxZoom: 19,
                  attribution: "¬© OpenStreetMap contributors",
                }).addTo(mapRef.current);
            
                // Ajout du marqueur
                markerRef.current = L.marker(position).addTo(mapRef.current);
            
                // Fix pour les soucis de rendu si le conteneur change de taille
                setTimeout(() => {
                  mapRef.current && mapRef.current.invalidateSize();
                }, 100);
              } else {
                // Si la carte existe d√©j√†, on la recadre simplement
                mapRef.current.setView(position, 18);
            
                if (markerRef.current) {
                  markerRef.current.setLatLng(position);
                } else {
                  markerRef.current = L.marker(position).addTo(mapRef.current);
                }
              }
            }


        async function reverseGeocode(lat, lon) {
          const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(
            lat
          )}&lon=${encodeURIComponent(lon)}&addressdetails=1`;

          const response = await fetch(url, {
            headers: {
              Accept: "application/json",
            },
          });

          if (!response.ok) {
            throw new Error("Erreur HTTP " + response.status);
          }

          return response.json();
        }

        function fillAddressFromNominatim(data) {
          const address = data.address || {};
          const houseNumber = address.house_number || "";
          const road =
            address.road ||
            address.pedestrian ||
            address.footway ||
            address.cycleway ||
            "";
          const finalStreet = [houseNumber, road].filter(Boolean).join(" ");
          if (finalStreet) {
            setStreet(finalStreet);
          }
        }

        function handleLocate() {
          if (!navigator.geolocation) {
            setStatus(
              "La g√©olocalisation n'est pas support√©e par ce navigateur. Saisissez l'adresse manuellement."
            );
            return;
          }

          setLocating(true);
          setStatus("R√©cup√©ration de la position GPS‚Ä¶");
          setError("");
          setCoords(null);

          navigator.geolocation.getCurrentPosition(
            async (position) => {
              const { latitude, longitude } = position.coords;
              setCoords({ lat: latitude, lng: longitude });
              setStatus("Position trouv√©e. Recherche de l'adresse la plus proche‚Ä¶");

              showOnMap(latitude, longitude);

              try {
                const data = await reverseGeocode(latitude, longitude);
                fillAddressFromNominatim(data);
                setStatus(
                  "Adresse estim√©e √† partir de votre position. Vous pouvez la corriger si n√©cessaire."
                );
              } catch (err) {
                console.error(err);
                setStatus(
                  "Impossible de r√©cup√©rer l'adresse √† partir de la position. Remplissez l'adresse manuellement."
                );
              } finally {
                setLocating(false);
              }
            },
            (error) => {
              console.error(error);
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  setStatus(
                    "Acc√®s √† la localisation refus√©. Vous pouvez remplir l'adresse manuellement."
                  );
                  break;
                case error.POSITION_UNAVAILABLE:
                  setStatus(
                    "Position introuvable. V√©rifiez le GPS ou le r√©seau, puis r√©essayez."
                  );
                  break;
                case error.TIMEOUT:
                  setStatus(
                    "Le temps de r√©cup√©ration de la localisation a expir√©. R√©essayez."
                  );
                  break;
                default:
                  setStatus(
                    "Erreur inconnue lors de la r√©cup√©ration de la localisation."
                  );
              }
              setLocating(false);
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0,
            }
          );
        }

        async function handleSubmit(e) {
          e.preventDefault();
          setError("");
          setSuccess(false);

          if (!street.trim()) {
            setError("Merci de renseigner au moins l'adresse (num√©ro + rue).");
            return;
          }

          const payload = {
            timestamp_iso: new Date().toISOString(),
            agent_id: agent?.id || null,
            agent_name: agent?.name || null,
            agent_team: agent?.team || null,
            street: street.trim(),
            commune: "Les Assions",
            postcode: "07140",
            country: "France",
            latitude: coords?.lat ?? null,
            longitude: coords?.lng ?? null,
            commentaire: comment.trim() || null,
            citizen_phone: citizenPhone.trim() || null,
            citizen_email: citizenEmail.trim() || null,
          };

          setSaving(true);
          try {
            await sendToSupabase(payload);
            setSuccess(true);
          } catch (err) {
            console.warn("Envoi Supabase √©chou√©, on stocke en local :", err);
            outboxPush(payload);
            setSuccess(true);
          } finally {
            setSaving(false);
            // on vide les champs pour une nouvelle saisie
            setStreet("");
            setComment("");
            setCitizenPhone("");
            setCitizenEmail("");
            setCoords(null);
            setStatus("Commune : Les Assions ‚Äî CP : 07140 ‚Äî Pays : France (fixes, seule l'adresse change).");
            setTimeout(() => setSuccess(false), 1500);
          }
        }

        return (
          <div className="mt-4">
            <div className="max-w-3xl mx-auto">
              <div className="bg-white rounded-2xl shadow p-4 mb-4 border">
                <h1 className="text-lg font-semibold mb-1">
                  Nouvelle distribution de tract
                </h1>
                <p className="text-sm text-gray-600">
                  Commune <span className="font-medium">Les Assions</span> ‚Äî{" "}
                  <span className="font-mono">07140</span> ‚Äî France.
                  <br />
                  Utilisez la localisation pour pr√©-remplir l'adresse, puis compl√©tez les
                  infos du citoyen rencontr√©.
                </p>
              </div>

              <div className="bg-white rounded-2xl shadow p-4 border">
                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
                  <button
                    type="button"
                    onClick={handleLocate}
                    disabled={locating}
                    className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-blue-600 text-white text-sm font-medium shadow hover:bg-blue-700 disabled:bg-gray-400"
                  >
                    üìç{" "}
                    {locating
                      ? "R√©cup√©ration de la position‚Ä¶"
                      : "Utiliser ma position actuelle"}
                  </button>
                  <div className="text-xs text-gray-500">
                    Le GPS sert uniquement √† estimer l'adresse et la placer sur la carte.
                  </div>
                </div>

                <div className="text-sm mb-2 text-gray-700 min-h-[1.5rem]">
                  {status}
                </div>

                {coords && (
                  <div className="text-xs text-gray-500 mb-2">
                    Coordonn√©es GPS :{" "}
                    <span className="font-mono">
                      {coords.lat.toFixed(6)}, {coords.lng.toFixed(6)}
                    </span>
                  </div>
                )}

                <div
                  ref={mapContainerRef}
                  className="w-full h-64 rounded-xl overflow-hidden border bg-gray-100 mb-4"
                ></div>

                <form onSubmit={handleSubmit} className="space-y-4">
                  <div>
                    <label className="block text-sm text-gray-700 mb-1">
                      Adresse (num√©ro + rue) *
                    </label>
                    <input
                      className="w-full border rounded-xl px-3 py-2 text-sm"
                      placeholder="Ex : 12 Rue du Village"
                      value={street}
                      onChange={(e) => setStreet(e.target.value)}
                    />
                  </div>

                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <div>
                      <label className="block text-sm text-gray-700 mb-1">
                        Commune
                      </label>
                      <input
                        className="w-full border rounded-xl px-3 py-2 text-sm bg-gray-50"
                        value="Les Assions"
                        readOnly
                      />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-700 mb-1">
                        Code postal
                      </label>
                      <input
                        className="w-full border rounded-xl px-3 py-2 text-sm bg-gray-50"
                        value="07140"
                        readOnly
                      />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-700 mb-1">
                        Pays
                      </label>
                      <input
                        className="w-full border rounded-xl px-3 py-2 text-sm bg-gray-50"
                        value="France"
                        readOnly
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm text-gray-700 mb-1">
                      Commentaire / notes de visite
                    </label>
                    <textarea
                      className="w-full border rounded-xl px-3 py-2 text-sm"
                      rows="3"
                      placeholder="Ex : Citoyen tr√®s int√©ress√©, parle de la voirie, √† recontacter apr√®s le 1er tour‚Ä¶"
                      value={comment}
                      onChange={(e) => setComment(e.target.value)}
                    />
                  </div>

                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm text-gray-700 mb-1">
                        T√©l√©phone du citoyen (optionnel)
                      </label>
                      <input
                        className="w-full border rounded-xl px-3 py-2 text-sm"
                        placeholder="06..."
                        value={citizenPhone}
                        onChange={(e) => setCitizenPhone(e.target.value)}
                        inputMode="tel"
                      />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-700 mb-1">
                        Email du citoyen (optionnel)
                      </label>
                      <input
                        className="w-full border rounded-xl px-3 py-2 text-sm"
                        placeholder="citoyen@example.com"
                        value={citizenEmail}
                        onChange={(e) => setCitizenEmail(e.target.value)}
                        type="email"
                        autoCapitalize="off"
                      />
                    </div>
                  </div>

                  {error && (
                    <div className="text-sm text-red-600">
                      {error}
                    </div>
                  )}

                  <div className="flex items-center justify-end gap-3 pt-2">
                    <button
                      type="submit"
                      disabled={saving}
                      className="btn-primary px-4 py-2 text-sm"
                    >
                      {saving ? "Enregistrement..." : "Enregistrer la distribution"}
                    </button>
                  </div>
                </form>

                {success && (
                  <div className="mt-3 text-sm text-green-700 bg-green-50 border border-green-200 rounded-xl px-3 py-2">
                    Distribution enregistr√©e (ou stock√©e en local si hors ligne) ‚úÖ
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }
      // ========================
      //   Viwer on Map
      // ========================
// ========================
//   Viewer on Map
// ========================
function Viewer({ onClose }) {
  const [rows, setRows] = React.useState([]);
  const [loading, setLoading] = React.useState(false);
  const [error, setError] = React.useState("");
  const [agentFilter, setAgentFilter] = React.useState("");
  const [limit, setLimit] = React.useState(200); // nombre max de points

  const mapRef = React.useRef(null);
  const markersLayerRef = React.useRef(null);
  const mapContainerRef = React.useRef(null);

  React.useEffect(() => {
    fetchRows();
    return () => {
      try {
        if (mapRef.current) {
          mapRef.current.remove();
          mapRef.current = null;
          markersLayerRef.current = null;
        }
      } catch {}
    };
  }, []);

  function escapeHtml(s) {
    if (!s) return "";
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  async function fetchRows() {
    setLoading(true);
    setError("");
    try {
      let url = `${CONFIG.SUPABASE_URL}/rest/v1/${CONFIG.TABLE}?select=*&order=created_at.desc&limit=${encodeURIComponent(
        limit
      )}`;

      if (agentFilter) {
        url += `&agent_id=eq.${encodeURIComponent(agentFilter)}`;
      }

      const res = await fetch(url, {
        headers: {
          apikey: CONFIG.SUPABASE_ANON_KEY,
          Authorization: `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
        },
      });

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`HTTP ${res.status} ‚Äî ${txt}`);
      }

      const data = await res.json();
      setRows(data || []);
      setTimeout(() => showRowsOnMap(data || []), 50);
    } catch (e) {
      console.warn("Viewer fetchRows error", e);
      setError(String(e.message || e));
    } finally {
      setLoading(false);
    }
  }

  function showRowsOnMap(data) {
    if (!window.L) {
      console.warn("Leaflet non charg√©");
      return;
    }

    if (!mapRef.current) {
      mapRef.current = L.map(mapContainerRef.current).setView(
        [44.5, 4.25], // Ard√®che
        12
      );
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "¬© OpenStreetMap contributors",
      }).addTo(mapRef.current);

      markersLayerRef.current = L.layerGroup().addTo(mapRef.current);

      setTimeout(() => {
        mapRef.current && mapRef.current.invalidateSize();
      }, 200);
    } else if (markersLayerRef.current) {
      markersLayerRef.current.clearLayers();
    }

    const coords = [];

    (data || []).forEach((r) => {
      const lat = Number(r.latitude);
      const lng = Number(r.longitude);
      if (!isFinite(lat) || !isFinite(lng)) return;

      coords.push([lat, lng]);

      // Construction de la popup √† l'ancienne (concat), plus safe
      let popupHtml = '<div style="min-width:180px">';
      popupHtml +=
        "<strong>" +
        escapeHtml(r.street || "Adresse inconnue") +
        "</strong><br/>";
      popupHtml +=
        "<small>" +
        escapeHtml(r.commune || "") +
        " " +
        escapeHtml(r.postcode || "") +
        "</small><br/>";

      if (r.commentaire) {
        popupHtml +=
          '<div style="margin-top:6px"><em>' +
          escapeHtml(r.commentaire) +
          "</em></div>";
      }

      popupHtml += '<div style="margin-top:6px;font-size:12px;color:#555">';
      popupHtml +=
        "Agent : " +
        escapeHtml(r.agent_name || r.agent_id || "") +
        "<br/>";

      if (r.citizen_phone) {
        popupHtml +=
          "üìû " + escapeHtml(r.citizen_phone) + "<br/>";
      }
      if (r.citizen_email) {
        popupHtml +=
          "‚úâ " + escapeHtml(r.citizen_email) + "<br/>";
      }

      if (r.created_at) {
        popupHtml +=
          '<div style="opacity:0.8;margin-top:4px">' +
          new Date(r.created_at).toLocaleString() +
          "</div>";
      }

      popupHtml += "</div></div>";

      const marker = L.marker([lat, lng]).bindPopup(popupHtml);
      markersLayerRef.current.addLayer(marker);
    });

    if (coords.length && mapRef.current) {
      const bounds = L.latLngBounds(coords);
      mapRef.current.fitBounds(bounds.pad(0.2));
    }
  }

  return (
    <div className="mt-4">
      <div className="max-w-6xl mx-auto">
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
          <div>
            <h2 className="text-lg font-semibold">Viewer des distributions</h2>
            <p className="text-sm text-gray-600">
              Visualisation des points GPS enregistr√©s dans Supabase.
            </p>
          </div>
          <div className="flex flex-wrap items-center gap-2">
            <select
              className="border rounded-xl px-3 py-2 text-sm"
              value={agentFilter}
              onChange={(e) => setAgentFilter(e.target.value)}
            >
              <option value="">Tous les agents</option>
              {AGENTS_LIST.map((a) => (
                <option key={a.id} value={a.id}>
                  {a.name}
                </option>
              ))}
            </select>
            <input
              className="border rounded-xl px-3 py-2 text-sm w-24"
              type="number"
              min="10"
              max="1000"
              value={limit}
              onChange={(e) =>
                setLimit(Number(e.target.value) || 100)
              }
              title="Nombre max de points"
            />
            <button
              onClick={fetchRows}
              className="btn-primary px-3 py-2 text-sm"
            >
              Rafra√Æchir
            </button>
            <button
              onClick={onClose}
              className="px-3 py-2 text-sm rounded-xl border bg-white hover:bg-gray-50"
            >
              Fermer
            </button>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div className="lg:col-span-2">
            <div
              ref={mapContainerRef}
              className="w-full h-64 md:h-[60vh] rounded-xl border bg-gray-100"
            ></div>
          </div>
          <div>
            <div className="bg-white rounded-xl border shadow-sm p-3 max-h-[60vh] overflow-auto">
              <div className="text-xs text-gray-500 mb-2">
                Total affich√© : {rows.length}
              </div>
              {loading && (
                <div className="text-sm text-gray-600">
                  Chargement‚Ä¶
                </div>
              )}
              {error && (
                <div className="text-sm text-red-600">
                  {error}
                </div>
              )}
              {rows.map((r) => (
                <div
                  key={r.id || `${r.agent_id}-${r.created_at}`}
                  className="pb-2 mb-2 border-b last:border-0 last:mb-0 last:pb-0"
                >
                  <div className="text-sm font-semibold">
                    {r.street || "‚Äî"}
                  </div>
                  <div className="text-xs text-gray-500">
                    {r.commune} {r.postcode}
                  </div>
                  <div className="text-xs mt-1 text-gray-700">
                    {r.commentaire ? (
                      r.commentaire.slice(0, 120)
                    ) : (
                      <em>Sans remarque</em>
                    )}
                  </div>
                  <div className="flex items-center justify-between mt-1 text-xs text-gray-500">
                    <span>{r.agent_name || r.agent_id}</span>
                    <span>
                      {r.created_at
                        ? new Date(
                            r.created_at
                          ).toLocaleDateString()
                        : ""}
                    </span>
                  </div>
                </div>
              ))}
            </div>
            <p className="mt-2 text-xs text-gray-500">
              Astuce : filtre par agent + limite pour all√©ger l‚Äôaffichage.
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}


  function showRowsOnMap(data) {
    if (!window.L) {
      console.warn("Leaflet non charg√©");
      return;
    }

    // init carte si besoin
    if (!mapRef.current) {
      mapRef.current = L.map(mapContainerRef.current).setView(
        [44.5, 4.25], // centre par d√©faut (Ard√®che)
        12
      );
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "¬© OpenStreetMap contributors",
      }).addTo(mapRef.current);

      markersLayerRef.current = L.layerGroup().addTo(mapRef.current);

      setTimeout(() => {
        mapRef.current && mapRef.current.invalidateSize();
      }, 200);
    } else {
      // clear anciens points
      if (markersLayerRef.current) {
        markersLayerRef.current.clearLayers();
      }
    }

    const coords = [];

    (data || []).forEach((r) => {
      const lat = Number(r.latitude);
      const lng = Number(r.longitude);
      if (!isFinite(lat) || !isFinite(lng)) return;

      coords.push([lat, lng]);

      const popupHtml = `
        <div style="min-width:180px">
          <strong>${escapeHtml(r.street || "Adresse inconnue")}</strong><br/>
          <small>${escapeHtml(r.commune || "")} ${escapeHtml(r.postcode || "")}</small><br/>
          ${
            r.commentaire
              ? `<div style="margin-top:6px"><em>${escapeHtml(
                  r.commentaire
                )}</em></div>`
              : ""
          }
          <div style="margin-top:6px;font-size:12px;color:#555">
            Agent : ${escapeHtml(r.agent_name || r.agent_id || "")}<br/>
            ${
              r.citizen_phone
                ? `üìû ${escapeHtml(r.citizen_phone)}<br/>`
                : ""
            }
            ${
              r.citizen_email
                ? `‚úâ ${escapeHtml(r.citizen_email)}<br/>`
                : ""
            }
            <div style="opacity:0.8;margin-top:4px">
              ${
                r.created_at
                  ? new Date(r.created_at).toLocaleString()
                  : ""
              }
            </div>
          </div>
        </div>
      `;

      const marker = L.marker([lat, lng]).bindPopup(popupHtml);
      markersLayerRef.current.addLayer(marker);
    });

    if (coords.length && mapRef.current) {
      const bounds = L.latLngBounds(coords);
      mapRef.current.fitBounds(bounds.pad(0.2));
    }
  }

  return (
    <div className="mt-4">
      <div className="max-w-6xl mx-auto">
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
          <div>
            <h2 className="text-lg font-semibold">Viewer des distributions</h2>
            <p className="text-sm text-gray-600">
              Visualisation des points GPS enregistr√©s dans Supabase.
            </p>
          </div>
          <div className="flex flex-wrap items-center gap-2">
            <select
              className="border rounded-xl px-3 py-2 text-sm"
              value={agentFilter}
              onChange={(e) => setAgentFilter(e.target.value)}
            >
              <option value="">Tous les agents</option>
              {AGENTS_LIST.map((a) => (
                <option key={a.id} value={a.id}>
                  {a.name}
                </option>
              ))}
            </select>
            <input
              className="border rounded-xl px-3 py-2 text-sm w-24"
              type="number"
              min="10"
              max="1000"
              value={limit}
              onChange={(e) =>
                setLimit(Number(e.target.value) || 100)
              }
              title="Nombre max de points"
            />
            <button
              onClick={fetchRows}
              className="btn-primary px-3 py-2 text-sm"
            >
              Rafra√Æchir
            </button>
            <button
              onClick={onClose}
              className="px-3 py-2 text-sm rounded-xl border bg-white hover:bg-gray-50"
            >
              Fermer
            </button>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div className="lg:col-span-2">
            <div
              ref={mapContainerRef}
              className="w-full h-[60vh] rounded-xl border bg-gray-100"
            ></div>
          </div>
          <div>
            <div className="bg-white rounded-xl border shadow-sm p-3 max-h-[60vh] overflow-auto">
              <div className="text-xs text-gray-500 mb-2">
                Total affich√© : {rows.length}
              </div>
              {loading && (
                <div className="text-sm text-gray-600">
                  Chargement‚Ä¶
                </div>
              )}
              {error && (
                <div className="text-sm text-red-600">
                  {error}
                </div>
              )}
              {rows.map((r) => (
                <div
                  key={r.id || `${r.agent_id}-${r.created_at}`}
                  className="pb-2 mb-2 border-b last:border-0 last:mb-0 last:pb-0"
                >
                  <div className="text-sm font-semibold">
                    {r.street || "‚Äî"}
                  </div>
                  <div className="text-xs text-gray-500">
                    {r.commune} {r.postcode}
                  </div>
                  <div className="text-xs mt-1 text-gray-700">
                    {r.commentaire ? (
                      r.commentaire.slice(0, 120)
                    ) : (
                      <em>Sans remarque</em>
                    )}
                  </div>
                  <div className="flex items-center justify-between mt-1 text-xs text-gray-500">
                    <span>{r.agent_name || r.agent_id}</span>
                    <span>
                      {r.created_at
                        ? new Date(
                            r.created_at
                          ).toLocaleDateString()}
                    </span>
                  </div>
                </div>
              ))}
            </div>
            <p className="mt-2 text-xs text-gray-500">
              Astuce : filtre par agent + limite pour all√©ger l‚Äôaffichage.
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}


      
      // ========================
      //   App
      // ========================
      function App() {
        const [agent, setAgent] = useLocalStorage(CONFIG.AGENT_KEY, null);
        const [viewerOpen, setViewerOpen] = React.useState(false);
      
        // Outbox auto
        React.useEffect(() => {
          outboxFlush();
          const id = setInterval(outboxFlush, 30000);
          return () => clearInterval(id);
        }, []);
      
        // Titre + theme-color
        React.useEffect(() => {
          document.title = CONFIG.APP_NAME;
          const metaTheme = document.querySelector('meta[name="theme-color"]');
          if (metaTheme) metaTheme.setAttribute("content", CONFIG.THEME_COLOR);
        }, []);
      
        if (!agent) {
          return <AgentSetup onSave={setAgent} />;
        }
      
        return (
          <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white">
            <Header
              agentName={agent?.name}
              onLogout={() => setAgent(null)}
              logoUrl={CONFIG.LOGO_URL}
              appName={CONFIG.APP_NAME}
              onOpenViewer={() => setViewerOpen(true)}
            />
            <main className="max-w-6xl mx-auto px-4 pb-8">
              {viewerOpen ? (
                <Viewer onClose={() => setViewerOpen(false)} />
              ) : (
                <DistributionScreen agent={agent} />
              )}
            </main>
          </div>
        );
      }


      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>










